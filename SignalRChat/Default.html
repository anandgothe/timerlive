<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />

    <title>Countdown Timer</title>
    <style type="text/css">
        .container {
            background-color: bisque;
            border: thick solid #808080;
            padding: 20px;
            margin: 20px;
            text-align: center;
        }

        #setTimerSection {
            text-align: center;
            font-size: 2vw;
        }

        input {
            font-size:4vw;
            margin:5px;
        }

        body {
            font-size: 2vw;
        }
    </style>
</head>
<body onfocus="pageGotFocus()" onblur="pageLostFocus()">
    <div class="container" id="sessionStart">
        <a href="faq.html" style="float:right">FAQ</a><br />
        Pick a name for your countdown session or join an existing session:<br />
        <input type="password" id="sessionid" /> <br />
        <br /><input type="button" id="goSession" value=" GO " style="margin-top:0px;"/> <br />
        <span>
            <li>
                You can use the same session name from any device to control the timer.
            </li>
            <li>
                To avoid misuse, session name entered by you isn't shown on screen, so remember your session name!
            </li>
            <li>
                Your feedback is welcome: <a href="https://goo.gl/XjcTfU">https://goo.gl/XjcTfU</a>
            </li>
            </span>
        <br />
    </div>

    <div id="sessionProgress" style="display:none">
        <div id="welcome" style="display:none"></div>

        <div id="setTimerSection">
            <span id="setTimer">
                Countdown in minutes: <input type="text" id="timerMinutes" style="width:150px" /> &nbsp;
                <input type="button" id="startTimer" value=" Start "/><br />
                Message (optional): <input type="text" id="timerMessage" />
            </span>
            <span id="setTimerExpand" style="display:none">
                <img src="expand1.png" />
            </span>
            <span id="setTimerCollapse">
                <img src="collapse1.png" />
            </span>
            <div id="tempMessage"></div>
        </div>
        <div id="timerMessageDisplay" style="text-align:center;font-size:3vw;"></div>
        <div id="timeleft" style="font-size:30vw;text-align:center;width:100%">
        </div>
    </div>

    <!--Script references. -->
    <!--Reference the jQuery library. -->
    <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.6.4.js"></script>
    <!--Reference the SignalR library. -->
    <script src="https://ajax.aspnetcdn.com/ajax/signalr/jquery.signalr-2.0.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="/signalr/hubs"></script>
    <!--Add script to update the page and send messages.-->
    <script type="text/javascript">

        document.chatClient = null;

        $(function () {
            // Declare a proxy to reference the hub.
            var chat = $.connection.chatHub;
            chat.intervalFunction = null;
            chat.secondsLeft = 0;
            // Set initial focus to message input box.
            $('#sessionid').focus();
            document.chatClient = chat;
            // Start the connection.
            $.connection.hub.start().done(function () {
                $('#goSession').click(function () {
                    chat.server.registerClient($('#sessionid').val());
                });

                $('#startTimer').click(function () {
                    var minutes = parseInt($('#timerMinutes').val());

                    if (isNaN(minutes)) {
                        alert("Not a valid number. Please use only integers");
                        return;
                    }

                    showTempMessage('You can use the same session name on any other device to see/control this countdown.');
                    chat.server.startTimer($('#sessionid').val(), $('#timerMinutes').val(), $('#timerMessage').val());
                    $("#setTimerCollapse").click();
                });
            });

            chat.client.sessionStarted = function (name, isTimerOn, seconds, message) {
                $('#sessionStart').hide();
                $('#sessionProgress').show();
                $('#welcome').text("Welcome to session " + name);

                if (isTimerOn == true) {
                    $("#setTimerCollapse").click();
                    chat.client.startCountdown(seconds, message);
                    $('#timerMessage').val(message);
                    $('#timerMinutes').val(Math.trunc(seconds / 60));
                }
                else {
                    $('#timerMinutes').focus();
                    $('#timerMessage').val('');
                    $('#timerMinutes').val('');
                }
            };
            
            chat.client.startCountdown = function (seconds, message) {
                $('#welcome').text("TIMER " + seconds);

                if (typeof message != 'undefined') {
                    $('#timerMessageDisplay').text(message);
                }

                if (chat.intervalFunction != null) {
                    clearInterval(chat.intervalFunction);
                }

                chat.secondsLeft = seconds;

                chat.intervalFunction = setInterval(function () {
                    var minute = chat.secondsLeft / 60;
                    var seconds = chat.secondsLeft % 60;

                        if (minute < -1) {
                            seconds = seconds * -1;
                    }

                        if (minute < 0) {
                            document.body.style.backgroundColor = "#E74C3C";
                            document.body.style.color = "WHITE";
                        }
                        else if (minute < 1) {
                            document.body.style.backgroundColor = "ORANGE";
                            document.body.style.color = "WHITE";
                        }
                        else {
                            document.body.style.backgroundColor = "WHITE";
                            document.body.style.color = "BLACK";
                        }

                    $("#timeleft").text(Math.trunc(minute) + ":" + Math.trunc(seconds));
                    //$("#timeleft").text(minute + ":" + seconds);
                    chat.secondsLeft--;
                }, 1000);
            };
        });
        
        $("#sessionid").keyup(function (event) {
            if (event.keyCode == 13) {
                $("#goSession").click();
            }
        });

        $("#timerMinutes").keyup(function (event) {
            if (event.keyCode == 13) {
                $("#startTimer").click();
            }
        });

        $("#setTimerExpand").click(function () {
            $("#setTimerExpand").hide();
            $("#setTimerCollapse").show();
            $("#setTimer").show();
        });

        $("#setTimerCollapse").click(function () {
            $("#setTimerExpand").show();
            $("#setTimerCollapse").hide();
            $("#setTimer").hide();
        });       

        function showTempMessage(message) {
            $('#tempMessage').text(message);
            $('#tempMessage').show();
            setTimeout("hideTempMessage()", 3000);
        }

        function hideTempMessage() {
            $('#tempMessage').hide();
        }

        var shouldRefresh = false;

        function pageGotFocus() {
            if (shouldRefresh) {
                shouldRefresh = false;
                document.chatClient.server.refreshTimer($('#sessionid').val());
            }
        }
        
        function pageLostFocus() {
            shouldRefresh = $('#sessionProgress').is(':visible');
        }

        function getUrlVars() {
            var vars = [], hash;
            var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
            for (var i = 0; i < hashes.length; i++) {
                hash = hashes[i].split('=');
                vars.push(hash[0]);
                vars[hash[0]] = hash[1];
            }
            return vars;
        }
        debugger;
        var params = getUrlVars();

        if (params.length > 0) {
            var s = params["s"];
            if (s != undefined) {
                $('#sessionid').val(s);
                setTimeout("$('#goSession').click();", 500);
            }
        }

    </script>
</body>
</html>